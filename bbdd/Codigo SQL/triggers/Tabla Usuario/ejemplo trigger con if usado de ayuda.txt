/*Con el fin de reducir la complejidad del ejercicio de cursores que estamos haciendo vamos a solucionarlo con
un nombre de tabla que se crea fijo. Por ejemplo, llamarle PEDIDOS_SUP_2022 (por lo tanto no hace falta pasarle 
a la rutina el a침o solo el importe)
En otro caso hay que parametrizar ese nombre de tabla y no hemos dado esa situaci칩n. Todo lo dem치s si que est치
explicado.  */
/* SOLUCION CON NOMBRE FIJO DE TABLA QUE SE CREA PEDIDOS_SUP_2022 */

CREATE DEFINER=`root`@`localhost` PROCEDURE `generar_pedidos`(
	IN `valor` FLOAT

)
LANGUAGE SQL
NOT DETERMINISTIC
CONTAINS SQL
SQL SECURITY DEFINER
COMMENT ''
BEGIN
DECLARE num FLOAT;
DECLARE lrf BOOL;
DECLARE np INT;
DECLARE fp DATE;
DECLARE cl INT;
DECLARE imp FLOAT;

DECLARE nomb VARCHAR(20);
DECLARE CURSOR1 CURSOR FOR SELECT Numpedido,Fechapedido,Clie,Importe  FROM PEDIDOS;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET lrf=1;

CREATE TABLE PEDIDOS_SUP_2022 (Numpedido INTEGER PRIMARY KEY,fechapedido DATE NOT NULL,clie INTEGER NOT NULL,importe INTEGER);

SET lrf=0; SET num=0;

OPEN CURSOR1;
L_CURSOR:LOOP

fetch CURSOR1 INTO np,fp,cl,imp;
if lrf=1 THEN
   LEAVE L_CURSOR;
END if;
if imp>=valor THEN
  SET num=num+1;
  INSERT INTO PEDIDOS_SUP_2022 VALUES (np,fp,cl,imp);
END if;

END LOOP L_CURSOR;
CLOSE CURSOR1;

SELECT num;
END